# spotify-auth-firebase-functions

This Nx Firebase application was generated by [@simondotm/nx-firebase](https://github.com/simondotm/nx-firebase).

## Generated Application Files

- `database.rules.json` - Default Firebase Realtime Database Rules
- `firestore.indexes.json` - Default Firebase Firestore Database Rules
- `package.json` - Default Firebase Functions package
- `storage.rules` - Default Firebase Storage Rules
- `src/index.ts` - Default Firebase Functions entry point
- `public/index.ts` - Default Firebase hosting site

## Generated Workspace Root Files

- `firebase.spotify-auth-firebase-functions.json` - Firebase CLI Configuration for this project
- `.firebaserc` - Default Firebase CLI Deployment Targets Configuration
- `firebase.json` - Intentionally Empty Firebase CLI Configuration (only needed to allow Firebase CLI to run in your workspace)

## Generated modules

Nx-Firebase will add `firebase-admin` and `firebase-functions` to your workspace `package.json` at the `'latest'` version. You may wish to set these to a specific version.

## Next Steps

- `npm install -g firebase-tools` - Install the [Firebase CLI](https://firebase.google.com/docs/cli)
- `firebase login` - Authenticate the Firebase CLI
- `firebase use --add` - Add your Firebase Project as a target to `.firebaserc`
- You do not need to `npm install` in the app project directory, but can still add and run custom npm scripts to the app `package.json` if you wish

See the plugin [README](https://github.com/simondotm/nx-firebase/blob/main/README.md) for more information.

### Update Remote Config

1. Init Firebase database:

```bash
firebase --config firebase.spotify-auth-firebase-functions.json init database
```

1.1. Enable required Google APIs:

```bash
gcloud services enable iamcredentials.googleapis.com
```

2. Copy the Client ID and Client Secret of your Spotify app and use them to set the spotify.client_id and spotify.client_secret Google Cloud environment variables. For this use:

```bash
firebase functions:config:set spotify.client_id="yourClientID" spotify.client_secret="yourClientSecret"
```

3. Set origin and basePath values:

```bash
firebase functions:config:set spotify.redirect_uri="http://localhost:3000/spotifyCallback"
```

4. 

```bash
gcloud functions add-iam-policy-binding helloWorld --member="allUsers" --role="roles/cloudfunctions.invoker"
gcloud functions add-iam-policy-binding spotifyAuth --member="allUsers" --role="roles/cloudfunctions.invoker"
 ```

5. Get the function url and add callback url to Spotify application settings.

```bash
gcloud functions describe --format=json spotifyAuth | jq -r .httpsTrigger.url
```

Output:
```bash
https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyAuth
# the full callback url should include /auth/spotify/callback path
# https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyAuth/auth/spotify/callback
```

6. Update Remote Config with new origin value:

```bash
firebase functions:config:set spotify.redirect_uri=https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyCallback
```
