# spotify-auth-firebase-functions

This Nx Firebase application was generated by [@simondotm/nx-firebase](https://github.com/simondotm/nx-firebase).

## Generated Application Files

- `database.rules.json` - Default Firebase Realtime Database Rules
- `firestore.indexes.json` - Default Firebase Firestore Database Rules
- `package.json` - Default Firebase Functions package
- `storage.rules` - Default Firebase Storage Rules
- `src/index.ts` - Default Firebase Functions entry point
- `public/index.ts` - Default Firebase hosting site

## Generated Workspace Root Files

- `firebase.spotify-auth-firebase-functions.json` - Firebase CLI Configuration for this project
- `.firebaserc` - Default Firebase CLI Deployment Targets Configuration
- `firebase.json` - Intentionally Empty Firebase CLI Configuration (only needed to allow Firebase CLI to run in your workspace)

## Generated modules

Nx-Firebase will add `firebase-admin` and `firebase-functions` to your workspace `package.json` at the `'latest'` version. You may wish to set these to a specific version.

## Next Steps

- `npm install -g firebase-tools` - Install the [Firebase CLI](https://firebase.google.com/docs/cli)
- `firebase login` - Authenticate the Firebase CLI
- `firebase use --add` - Add your Firebase Project as a target to `.firebaserc`
- You do not need to `npm install` in the app project directory, but can still add and run custom npm scripts to the app `package.json` if you wish

See the plugin [README](https://github.com/simondotm/nx-firebase/blob/main/README.md) for more information.

## Setup google cloud project and configure required APIs:
 1. Obtains access credentials for your user account.
```bash
gcloud auth login --no-launch-browser
```

Output:
```bash
You are now logged in as [vymarkov@gmail.com].
Your current project is [None].  You can change this setting by running:
  $ gcloud config set project PROJECT_ID


Updates are available for some Cloud SDK components.  To install them,
please run:
  $ gcloud components update
```

 1. Set the default project.
```bash
gcloud config set project you_project_name
```
 1. Enable required Google APIs.

```bash
gcloud services enable iamcredentials.googleapis.com
```

## Create and setup your Spotify app:
 1. Create a Spotify app in the [Spotify Developers website](https://developer.spotify.com/my-applications/).
 1. Add the URL `https://5001-<gitpod-workspace-id>.gitpod.io/spotify-get-rid-of-shit/us-central1/spotifyCallback` to the
    **Redirect URIs** of your Spotify app.
 1. Add the URL `http://localhost:5001/spotify-get-rid-of-shit/us-central1/spotifyCallback` to the
    **Redirect URIs** of your Spotify app.
 1. Add the URL `https://us-central1-<your-gcp-project-id>.cloudfunctions.net/spotifyCallback` to the
    **Redirect URIs** of your Spotify app.

    1. Receive gcp project id:
    ```bash
    gcloud config get-value project
    ```
 
 1. Copy the **Client ID** and **Client Secret** of your Spotify app and use them to set the `spotify.client_id` and `spotify.client_secret` Google Cloud environment variables. For this use:

    ```bash
    firebase functions:config:set spotify.client_id="yourClientID" spotify.client_secret="yourClientSecret"
    ```

 > Make sure the Spotify Client Secret is always kept secret. For instance do not save this in your version control system.


2. Copy the Client ID and Client Secret of your Spotify app and use them to set the spotify.client_id and spotify.client_secret Google Cloud environment variables. For this use:

```bash
firebase functions:config:set spotify.client_id="yourClientID" spotify.client_secret="yourClientSecret"
```

3. Set origin and basePath values:

```bash
firebase functions:config:set spotify.redirect_uri="http://localhost:3000/spotifyCallback"
```

4. 

```bash
gcloud functions add-iam-policy-binding helloWorld --member="allUsers" --role="roles/cloudfunctions.invoker"
gcloud functions add-iam-policy-binding spotifyAuth --member="allUsers" --role="roles/cloudfunctions.invoker"
 ```

5. Get the function url and add callback url to Spotify application settings.

```bash
gcloud functions describe --format=json spotifyAuth | jq -r .httpsTrigger.url
```

Output:
```bash
https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyAuth
# the full callback url should include /auth/spotify/callback path
# https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyAuth/auth/spotify/callback
```

6. Update Remote Config with new origin value:

```bash
firebase functions:config:set spotify.redirect_uri=https://us-central1-spotify-get-rid-of-shit.cloudfunctions.net/spotifyCallback
```
